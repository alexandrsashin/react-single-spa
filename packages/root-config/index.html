<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Root Config</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />

    <!-- React Refresh Setup (development only) -->
    <script src="/importmap-loader.js"></script>

    <!-- This script is required for react-refresh to work properly -->
    <script>
      (async function () {
        // Wait for importmap-loader to be ready
        if (typeof window.getEnvironment !== "function") {
          console.warn("[react-refresh] getEnvironment not available yet");
          return;
        }

        const env = window.getEnvironment();
        if (env !== "development") {
          console.log("[react-refresh] skipping in", env, "mode");
          return;
        }

        try {
          const { setupReactRefresh } = await import("/react-refresh-setup.js");
          setupReactRefresh();
        } catch (error) {
          // Не ломаем загрузку приложения из-за несущественной ошибки
          // (например, модуль недоступен). Логируем для отладки.
          console.warn("[react-refresh] failed to load:", error);
        }
      })();
    </script>

    <!-- Dynamic importmap loading -->
    <script>
      // Load importmap before any module imports
      window
        .loadImportMap()
        .then(() => {
          console.log("Environment:", window.getEnvironment());
          // Import root config after importmap is loaded
          // Tell Vite to ignore rewriting this specifier so the importmap
          // entry for "root-config" can take effect at runtime.
          import(/* @vite-ignore */ "root-config").catch((err) => {
            console.error("Failed to load root-config:", err);
          });
        })
        .catch((err) => {
          console.error(
            "Failed to load importmap, falling back to static:",
            err
          );
          // Fallback: try to import anyway
          // If importmap failed to load, try a direct dev path so the browser
          // doesn't attempt to fetch a bare specifier like /root-config which
          // returns HTML instead of JS.
          const devEntry = "/src/main.ts";
          const specifier =
            typeof window.getEnvironment === "function" &&
            window.getEnvironment() === "development"
              ? devEntry
              : "root-config";
          import(/* @vite-ignore */ specifier).catch((importErr) => {
            console.error(
              "Failed to load root-config even with fallback:",
              importErr
            );
          });
        });
    </script>
  </head>

  <body>
    <noscript> You need to enable JavaScript to run this app. </noscript>

    <!-- Development tools -->
    <import-map-overrides-full
      show-when-local-storage="devtools"
      dev-libs
    ></import-map-overrides-full>
  </body>
</html>
